name: Auto-merge PR

on:
  workflow_run:
    workflows: ["iOS Build and Test"]
    types:
      - completed

jobs:
  auto-merge:
    name: Auto-merge after checks pass
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
    
    steps:
      - name: Find Pull Request
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ github.event.workflow_run.head_sha }}';
            const headBranch = '${{ github.event.workflow_run.head_branch }}';
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`,
            });
            
            if (prs.length > 0) {
              const pr = prs.find(p => p.head.sha === headSha) || prs[0];
              core.setOutput('number', pr.number);
              core.setOutput('base', pr.base.ref);
              core.setOutput('draft', pr.draft);
              core.setOutput('mergeable', pr.mergeable);
              core.setOutput('merged', pr.merged);
              console.log(`Found PR #${pr.number}`);
              return pr.number;
            }
            console.log('No open PR found');
            return null;

      - name: Wait for all checks to complete
        if: steps.find-pr.outputs.number != ''
        id: wait-checks
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ github.event.workflow_run.head_sha }}';
            const maxWaitTime = 30 * 60 * 1000;
            const checkInterval = 15 * 1000;
            const startTime = Date.now();
            
            console.log('Waiting for all checks to complete...');
            console.log(`Commit: ${headSha}`);
            
            while (Date.now() - startTime < maxWaitTime) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha,
              });
              
              const allChecks = checks.check_runs || [];
              const completedChecks = allChecks.filter(c => c.status === 'completed');
              const inProgressChecks = allChecks.filter(c => c.status === 'in_progress' || c.status === 'queued');
              const successfulChecks = completedChecks.filter(c => c.conclusion === 'success');
              const failedChecks = completedChecks.filter(c => 
                c.conclusion === 'failure' || 
                c.conclusion === 'cancelled' || 
                c.conclusion === 'timed_out' ||
                c.conclusion === 'action_required'
              );
              
              console.log(`\n=== Check Status (${new Date().toISOString()}) ===`);
              console.log(`Total checks: ${allChecks.length}`);
              console.log(`  Completed: ${completedChecks.length}`);
              console.log(`  In progress: ${inProgressChecks.length}`);
              console.log(`  Successful: ${successfulChecks.length}`);
              console.log(`  Failed: ${failedChecks.length}`);
              
              if (allChecks.length > 0) {
                console.log('\nCheck details:');
                allChecks.forEach(check => {
                  console.log(`  - ${check.name}: ${check.status} (${check.conclusion || 'N/A'})`);
                });
              }
              
              if (failedChecks.length > 0) {
                console.log(`\nFailed checks detected:`);
                failedChecks.forEach(check => {
                  console.log(`  - ${check.name}: ${check.conclusion}`);
                });
                core.setOutput('all_passed', 'false');
                return { allPassed: false, state: 'failure' };
              }
              
              if (allChecks.length > 0 && inProgressChecks.length === 0) {
                if (completedChecks.length === allChecks.length && successfulChecks.length === completedChecks.length) {
                  console.log('\nAll checks passed successfully!');
                  core.setOutput('all_passed', 'true');
                  return { allPassed: true, state: 'success' };
                }
              }
              
              if (allChecks.length === 0) {
                console.log('\nNo checks found via Checks API, but main workflow completed successfully');
                console.log('Considering all checks passed');
                core.setOutput('all_passed', 'true');
                return { allPassed: true, state: 'success' };
              }
              
              console.log(`\nWaiting ${checkInterval / 1000} seconds before next check...`);
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            console.log('\nTimeout waiting for checks');
            core.setOutput('all_passed', 'false');
            return { allPassed: false, state: 'timeout' };

      - name: Auto-merge Pull Request
        if: |
          steps.find-pr.outputs.number != '' && 
          steps.wait-checks.outputs.all_passed == 'true' &&
          steps.find-pr.outputs.merged == 'false' &&
          steps.find-pr.outputs.draft == 'false' &&
          steps.find-pr.outputs.mergeable == 'true' &&
          (steps.find-pr.outputs.base == 'main' || steps.find-pr.outputs.base == 'development')
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Merge PR #${prNumber}: ${pr.title}`,
                commit_message: `Automatically merged after all checks passed\n\n${pr.body || ''}`,
              });
              console.log(`PR #${prNumber} successfully auto-merged`);
            } catch (error) {
              console.log(`Failed to auto-merge PR: ${error.message}`);
            }