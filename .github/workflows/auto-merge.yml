name: Auto-merge PR

on:
  workflow_run:
    workflows: ["iOS Build and Test"]
    types:
      - completed
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  auto-merge:
    name: Auto-merge after checks pass
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request') ||
      (github.event_name == 'pull_request' && github.event.pull_request != null)
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Find Pull Request
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            let headSha, headBranch, prNumber;
            
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              headSha = context.payload.pull_request.head.sha;
              headBranch = context.payload.pull_request.head.ref;
            } else if (context.eventName === 'workflow_run') {
              headSha = context.payload.workflow_run.head_sha;
              headBranch = context.payload.workflow_run.head_branch;
              
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${headBranch}`,
              });
              
              if (prs.length > 0) {
                const pr = prs.find(p => p.head.sha === headSha) || prs[0];
                prNumber = pr.number;
              }
            }
            
            if (prNumber) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              
              core.setOutput('number', pr.number);
              core.setOutput('base', pr.base.ref);
              core.setOutput('draft', pr.draft);
              core.setOutput('mergeable', pr.mergeable);
              core.setOutput('merged', pr.merged);
              console.log(`Found PR #${pr.number}`);
              return pr.number;
            }
            console.log('No open PR found');
            return null;

      - name: Wait for all checks to complete
        if: steps.find-pr.outputs.number != ''
        run: sleep 10

      - name: Check all status checks
        if: steps.find-pr.outputs.number != ''
        id: status-checks
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.number }};
            let headSha;
            
            if (context.eventName === 'pull_request') {
              headSha = context.payload.pull_request.head.sha;
            } else if (context.eventName === 'workflow_run') {
              headSha = context.payload.workflow_run.head_sha;
            }
            
            // Получить комбинированный статус проверок
            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha,
            });
            
            const allPassed = status.state === 'success';
            console.log(`Combined status: ${status.state}`);
            console.log(`Total checks: ${status.total_count}`);
            console.log(`Passed: ${status.statuses.filter(s => s.state === 'success').length}`);
            
            // Если это workflow_run и он успешен, считаем что все проверки прошли
            if (context.eventName === 'workflow_run' && context.payload.workflow_run.conclusion === 'success') {
              core.setOutput('all_passed', 'true');
              return { allPassed: true, state: 'success' };
            }
            
            core.setOutput('all_passed', allPassed);
            return { allPassed, state: status.state };

      - name: Auto-merge Pull Request
        if: |
          steps.find-pr.outputs.number != '' && 
          steps.status-checks.outputs.all_passed == 'true' &&
          steps.find-pr.outputs.merged == 'false' &&
          steps.find-pr.outputs.draft == 'false' &&
          steps.find-pr.outputs.mergeable == 'true' &&
          (steps.find-pr.outputs.base == 'main' || steps.find-pr.outputs.base == 'development')
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Merge PR #${prNumber}: ${pr.title}`,
                commit_message: `Automatically merged after all checks passed\n\n${pr.body || ''}`,
              });
              console.log(`PR #${prNumber} успешно автоматически слит`);
            } catch (error) {
              console.log(`Не удалось автоматически слить PR: ${error.message}`);
            }

