name: Auto-merge PR

on:
  workflow_run:
    workflows: ["iOS Build and Test"]
    types:
      - completed

jobs:
  auto-merge:
    name: Auto-merge after checks pass
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    permissions:
      contents: write
      pull-requests: write
      checks: read
      statuses: read
    
    steps:
      - name: Find Pull Request
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ github.event.workflow_run.head_sha }}';
            const headBranch = '${{ github.event.workflow_run.head_branch }}';
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`,
            });
            
            if (prs.length > 0) {
              const pr = prs.find(p => p.head.sha === headSha) || prs[0];
              core.setOutput('number', pr.number);
              core.setOutput('base', pr.base.ref);
              core.setOutput('draft', pr.draft);
              core.setOutput('mergeable', pr.mergeable);
              core.setOutput('merged', pr.merged);
              console.log(`Found PR #${pr.number}`);
              return pr.number;
            }
            console.log('No open PR found');
            return null;

      - name: Wait for all checks to complete
        if: steps.find-pr.outputs.number != ''
        id: wait-checks
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ github.event.workflow_run.head_sha }}';
            const maxWaitTime = 30 * 60 * 1000; // 30 минут максимум
            const checkInterval = 10 * 1000; // Проверяем каждые 10 секунд
            const startTime = Date.now();
            
            console.log('Ожидание завершения всех проверок...');
            
            while (Date.now() - startTime < maxWaitTime) {
              const { data: status } = await github.rest.repos.getCombinedStatusForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha,
              });
              
              console.log(`Статус проверок: ${status.state}`);
              console.log(`Всего проверок: ${status.total_count}`);
              console.log(`Успешно: ${status.statuses.filter(s => s.state === 'success').length}`);
              console.log(`В процессе: ${status.statuses.filter(s => s.state === 'pending').length}`);
              console.log(`Провалено: ${status.statuses.filter(s => s.state === 'failure' || s.state === 'error').length}`);
              
              // Если все проверки завершены
              if (status.state !== 'pending') {
                if (status.state === 'success') {
                  console.log('Все проверки прошли успешно!');
                  core.setOutput('all_passed', 'true');
                  return { allPassed: true, state: status.state };
                } else {
                  console.log(`Некоторые проверки провалились. Статус: ${status.state}`);
                  core.setOutput('all_passed', 'false');
                  return { allPassed: false, state: status.state };
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            console.log('Превышено время ожидания проверок');
            core.setOutput('all_passed', 'false');
            return { allPassed: false, state: 'timeout' };

      - name: Auto-merge Pull Request
        if: |
          steps.find-pr.outputs.number != '' && 
          steps.wait-checks.outputs.all_passed == 'true' &&
          steps.find-pr.outputs.merged == 'false' &&
          steps.find-pr.outputs.draft == 'false' &&
          steps.find-pr.outputs.mergeable == 'true' &&
          (steps.find-pr.outputs.base == 'main' || steps.find-pr.outputs.base == 'development')
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.find-pr.outputs.number }};
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Merge PR #${prNumber}: ${pr.title}`,
                commit_message: `Automatically merged after all checks passed\n\n${pr.body || ''}`,
              });
              console.log(`PR #${prNumber} успешно автоматически слит`);
            } catch (error) {
              console.log(`Не удалось автоматически слить PR: ${error.message}`);
            }
